#!/usr/bin/env python3

import cgitb, cgi
import sys
import matplotlib
matplotlib.use('agg')
from soccerimg import most_recent_image, game_roster, plot_players, \
        dayrow_extract, stream_plot

cgitb.enable()
form = cgi.FieldStorage()
match_date = form.getfirst('date')
if match_date is None:
    img = most_recent_image()
else:
    dayrow = game_roster(match_date)
    fig = plot_players(**dayrow_extract(dayrow))
    img = stream_plot(fig)

# stop gmail proxy cache
# https://stackoverflow.com/questions/21802820/dynamic-images-for-email-such-as-countdown-clocks-in-light-of-gmail-image-cachi
print("Cache-Control: no-store, no-cache, must-revalidate, max-age=0")
print("Cache-Control: post-check=0, pre-check=0")
print("Pragma: no-cache")
print("Content-type: image/png\n")
sys.stdout.flush()
sys.stdout.buffer.write(img)
